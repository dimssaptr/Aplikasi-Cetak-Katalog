<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>BiblioPrint - V1</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <style>
        /* --- CSS UTAMA --- */
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f5; margin: 0; padding: 20px; padding-bottom: 150px; }
        .container { max-width: 98%; margin: 0 auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; margin-top: 0; display: flex; justify-content: space-between; align-items: center; }
        
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 13px; width: 100%; }
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .form-col { flex: 1; }
        label { display: block; font-weight: 600; font-size: 12px; margin-bottom: 4px; color: #34495e; }

        .io-box { background: #e8f8f5; border: 1px solid #a2d9ce; padding: 15px; border-radius: 5px; margin-bottom: 20px; display: flex; align-items: flex-end; gap: 10px; flex-wrap: wrap; }
        #settings-box { display: none; background: #f8f9fa; border: 1px solid #ced4da; padding: 15px; border-radius: 5px; margin-bottom: 20px; }

        /* --- STAGING TABLE --- */
        .staging-wrapper { max-height: 500px; overflow: auto; border: 1px solid #ccc; margin-bottom: 15px; background: white; }
        .staging-table { width: 100%; border-collapse: collapse; font-size: 12px; min-width: 1200px; }
        
        .staging-table th { 
            background: #34495e; color: white; padding: 10px; 
            position: sticky; top: 0; z-index: 10; text-align: left; white-space: nowrap; 
        }
        
        .del-col-btn {
            color: #ff9999; cursor: pointer; margin-left: 8px; font-weight: bold; font-size: 14px;
            text-decoration: none; padding: 2px 5px; border-radius: 3px;
        }
        .del-col-btn:hover { background: rgba(255,255,255,0.2); color: white; }

        .staging-table td { border-bottom: 1px solid #eee; padding: 0; min-width: 100px; transition: background 0.3s; }
        
        /* Highlight Error Row */
        .row-error td { background-color: #ffe6e6 !important; border-bottom: 1px solid #ffcccc; }
        .row-error input, .row-error select { background-color: rgba(255,255,255,0.5); }

        /* Input seamless */
        .tbl-input { width: 100%; border: none; padding: 8px; background: transparent; font-family: inherit; font-size: 12px; }
        .tbl-input:focus { background: #fffbe6; outline: 2px solid #f1c40f; }
        
        select.tbl-input { cursor: pointer; appearance: none; -webkit-appearance: none; padding-right: 15px; }

        /* Delete Row Button */
        .btn-del-row {
            background: #e74c3c; color: white; border: none; border-radius: 3px;
            width: 20px; height: 20px; line-height: 18px; text-align: center;
            cursor: pointer; font-size: 10px; display: inline-block; margin-right: 5px;
        }
        .btn-del-row:hover { background: #c0392b; }

        .staging-controls { background: #fff3cd; padding: 15px; border: 1px solid #ffeeba; border-bottom: none; border-radius: 5px 5px 0 0; }
        .bulk-bar { display: flex; gap: 10px; align-items: center; padding-bottom: 10px; border-bottom: 1px dashed #d4ac0d; margin-bottom: 10px; flex-wrap: wrap; }
        .bulk-label { font-weight: bold; color: #7f6000; font-size: 13px; display: flex; align-items: center; gap: 5px; }

        .btn { padding: 10px 15px; border: none; cursor: pointer; color: white; border-radius: 4px; font-weight: bold; font-size: 13px; transition: 0.2s; white-space: nowrap; display: inline-flex; justify-content: center; align-items: center; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .c-blue { background: #2980b9; } .c-green { background: #27ae60; } .c-orange { background: #f39c12; }
        .c-red { background: #c0392b; } .c-purple { background: #8e44ad; } .c-grey { background: #7f8c8d; }

        .action-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .action-grid button { width: 100%; }
        .staging-action-bar { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; gap: 10px; flex-wrap: wrap; }

        #dynamic-fields-area { margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 10px; }
        .dynamic-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: flex-end; }
        .btn-sm-del { background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; width: auto; }

        #preview-section { width: 100%; max-width: 21cm; margin: 0 auto; background: #fff; min-height: 200px; padding: 20px; border: 2px dashed #bbb; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 10px; }
        .placeholder-text { width: 100%; text-align: center; color: #aaa; padding-top: 50px; font-style: italic; }

        .print-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #2c3e50; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.2); z-index: 1000; }

        @media print {
            body { background: white; padding: 0; margin: 0; }
            .container, .print-bar, .delete-btn { display: none !important; }
            #preview-section { border: none; width: 100%; max-width: 100%; margin: 0; padding: 0; display: block; }
            .print-item-wrapper { float: left; margin: 5px; page-break-inside: avoid; }
            @page { margin: 0.5cm; size: auto; }
        }

        .print-item-wrapper { position: relative; display: inline-block; vertical-align: top; margin: 5px; }
        .delete-btn { position: absolute; top: -8px; right: -8px; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; text-align: center; line-height: 20px; cursor: pointer; font-weight: bold; font-size: 12px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10; }

        .kartu-induk { width: 12cm; min-height: 9.5cm; height: auto; border: 1px solid black; padding: 15px; font-family: "Times New Roman", serif; font-size: 11pt; background: white; box-sizing: border-box; display: flex; flex-direction: column; }
        .tbl-data { width: 100%; border-collapse: collapse; margin-top: 5px; }
        .tbl-data td { vertical-align: top; padding: 3px 0; } 
        .col-lbl { font-weight: bold; width: 22%; line-height: 1.2; } .col-sep { width: 2%; text-align: center; } .col-val { width: 76%; border-bottom: 1px dotted #ccc; }
        
        .eng { display: block; font-size: 8pt; font-style: italic; color: #555; font-weight: normal; margin-top: 2px; }
        .combo-row { display: flex; width: 100%; border-bottom: 1px dotted #ccc; padding-bottom: 2px; }
        .combo-item { flex: 1; margin-right: 5px; }
        .combo-label { font-weight: bold; font-size: 11pt; } .combo-eng { font-size: 8pt; font-style: italic; color: #555; display: block; line-height: 1; }

        .sticker-unit { display: inline-flex; border: 1px dashed #ccc; padding: 3px; background: white; align-items: center; gap: 3px; }
        .spine-label { width: 3cm; height: 4cm; border: 1px solid black; display: flex; flex-direction: column; text-align: center; }
        .color-strip { height: 12px; border-bottom: 1px solid #ccc; width: 100%; -webkit-print-color-adjust: exact; }
        .lbl-content { flex: 1; display: flex; flex-direction: column; justify-content: center; font-weight: bold; font-family: Arial; }
        
        .barcode-box { 
            width: 4.5cm; height: 4cm; border: 1px solid black; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            text-align: center; padding: 2px; background: white; overflow: hidden;
        }
        .barcode-box svg { display: block; width: 95%; min-height: 40px; margin: 5px 0; }
        .barcode-title { font-size: 9pt; white-space: nowrap; overflow: hidden; width: 100%; text-align: center; margin-top: 2px; } 
    </style>
</head>
<body>

<div class="container">
    <h2>
        BiblioPrint <span style="font-size:14px;color:#7f8c8d;">(by dimassaputra@upi.edu)</span>
        <span style="font-size:14px; color:#3498db; cursor: pointer; text-decoration: underline;" onclick="toggleSettings()">‚öôÔ∏è Pengaturan Kopsurat</span>
    </h2>

    <div id="settings-box">
        <b style="color:#e67e22;">Edit Kop & Label</b>
        <div class="form-row">
            <div class="form-col"><label>Nama Instansi 1</label><input type="text" id="conf_instansi_1" value="UPT PERPUSTAKAAN" oninput="saveConfig()"></div>
            <div class="form-col"><label>Nama Instansi 2</label><input type="text" id="conf_instansi_2" value="POLITEKNIK NEGERI BANDUNG" oninput="saveConfig()"></div>
        </div>
        <div class="form-row">
            <div class="form-col"><label>Label Punggung</label><input type="text" id="conf_label" value="POLBAN" oninput="saveConfig()"></div>
            <div class="form-col"><label>Barcode Header</label><input type="text" id="conf_barcode" value="UPT Perpustakaan" oninput="saveConfig()"></div>
        </div>
    </div>

    <div class="io-box">
        <div style="flex:2; min-width: 300px;">
            <b>Mode Input Data (Spreadsheet):</b><br>
            <small style="color:#555;">Import CSV atau Edit langsung di tabel.</small>
        </div>
        
        <div style="flex:1; min-width: 150px;">
            <label style="margin-bottom:2px;">Default Import:</label>
            <select id="importType" style="padding:6px;">
                <option value="a">a. Textbook</option>
                <option value="b">b. Reference</option>
                <option value="c">c. Catalog</option>
                <option value="d">d. Journal</option>
                <option value="e">e. Periodical</option>
                <option value="f">f. Lainnya</option>
            </select>
        </div>

        <div style="flex:1; min-width: 250px; display:flex; gap:5px; align-items: flex-end;">
            <input type="file" id="csvFileInput" accept=".csv" style="padding:5px; background:white; border:1px solid #ccc;">
            <button class="btn c-green" onclick="processCSV()">üìÇ Import</button>
        </div>
    </div>

    <div id="staging-controls" class="staging-controls" style="display:block;">
        <div class="bulk-bar">
            <div class="bulk-label">üìù TABEL EDITOR:</div>
            
            <button class="btn c-purple" onclick="addEmptyRows(5)">+ 5 Baris Kosong</button>
            <button class="btn c-grey" onclick="addCustomColumn()">+ Kolom Baru</button>

            <div style="border-left:1px solid #aaa; margin:0 10px; padding-left:10px; display:flex; gap:5px; align-items:center;">
                <span style="font-size:12px; font-weight:bold;">Edit Massal:</span>
                <select id="bulk-target-field" style="width:120px;" onchange="updateBulkInputType()">
                    <option value="type">Jenis Koleksi</option>
                    <option value="barcode">No. Barcode</option>
                    <option value="resource">Sumber</option>
                    <option value="date">Tanggal</option>
                    <option value="publisher">Penerbit</option>
                    <option value="city">Kota</option>
                </select>
                <span id="bulk-input-container">
                    <input type="text" id="bulk-value-input" placeholder="Isi..." style="width:120px;">
                </span>
                <button class="btn c-orange" onclick="applyBulkAction()">Set</button>
            </div>
        </div>

        <div class="staging-action-bar">
            <div><b>Total Data:</b> <span id="staging-count">0</span> item.</div>
            <div style="display:flex; gap:5px;">
                <select id="bulk-mode" style="width:auto; padding:8px;">
                    <option value="gabung">Label + Barcode</option>
                    <option value="kartu">Kartu Induk</option>
                    <option value="label">Label Punggung Saja</option>
                    <option value="barcode">Barcode Saja</option>
                </select>
                <button class="btn c-blue" onclick="generateFromStaging()">‚¨áÔ∏è Generate</button>
                <button class="btn c-red" onclick="clearStaging()">Hapus Semua</button>
            </div>
        </div>
    </div>

    <div id="staging-wrapper" class="staging-wrapper">
        <table class="staging-table" id="staging-table">
            <thead id="staging-head"></thead>
            <tbody id="staging-body"></tbody>
        </table>
    </div>

    <hr style="border:0; border-top:2px solid #eee; margin:20px 0;">

    <details>
        <summary style="cursor:pointer; font-weight:bold; color:#2c3e50; margin-bottom:10px; font-size:16px;">Input Manual (Formulir Satu per Satu)</summary>
        <div style="padding:15px; background:#f9f9f9; border-radius:5px; border:1px solid #eee;">
            <div class="form-row">
                <div class="form-col">
                    <label>Jenis Koleksi</label>
                    <select id="type" onchange="toggleCustomInput()">
                        <option value="a">a. Textbook</option><option value="b">b. Reference</option>
                        <option value="c">c. Catalog</option><option value="d">d. Journal</option>
                        <option value="e">e. Periodical</option><option value="f">f. Lainnya</option>
                    </select>
                    <input type="text" id="customTypeInput" placeholder="Ketik jenis..." style="display:none; margin-top:5px; background:#fffbe6; border-color:#f1c40f;">
                </div>
                <div class="form-col"><label>DDC (Klasifikasi)</label><input type="text" id="classNo" placeholder="600"></div>
                <div class="form-col"><label>Call No (Label)</label><input type="text" id="callNo" placeholder="600 ABC t"></div>
            </div>
            <div class="form-row"><div class="form-col"><label>Penulis</label><input type="text" id="author"></div><div class="form-col" style="flex:2;"><label>Judul</label><input type="text" id="title"></div></div>
            <div class="form-row"><div class="form-col"><label>Jilid/Cet. ke</label><input type="text" id="part"></div><div class="form-col"><label>Tahun</label><input type="text" id="year"></div><div class="form-col"><label>Edisi</label><input type="text" id="edition"></div></div>
            <div class="form-row"><div class="form-col"><label>Harga</label><input type="text" id="price"></div><div class="form-col"><label>Tanggal Input</label><input type="date" id="date"></div><div class="form-col"><label>Sumber</label><input type="text" id="resource"></div></div>
            <div class="form-row"><div class="form-col"><label>Penerbit</label><input type="text" id="publisher"></div><div class="form-col"><label>Kota Terbit</label><input type="text" id="city"></div></div>
            <div class="form-row"><div class="form-col"><label>Ukuran</label><input type="text" id="measure"></div><div class="form-col"><label>Jumlah Halaman</label><input type="text" id="pages"></div></div>

            <div class="form-row" style="background:#eafaf1; padding:10px; border-radius:5px; border:1px solid #abebc6;">
                <div class="form-col"><label>No. Rek (ACC)</label><input type="text" id="accNo" placeholder="Masuk ke Kartu Induk"></div>
                <div class="form-col"><label style="color:#d35400;">No. Barcode</label><input type="text" id="barcodeInput" placeholder="Untuk Gambar Barcode"></div>
                <div class="form-col"><label>No. Inventaris</label><input type="text" id="inventaris"></div>
                <div class="form-col"><label>ISBN/ISSN</label><input type="text" id="isbn"></div>
            </div>
            <div id="dynamic-fields-area"></div>
            <button class="btn c-grey" style="width:100%; margin-top:5px; margin-bottom:15px;" onclick="addDynamicFieldManual()">+ Tambah Baris Custom</button>
            <div class="action-grid">
                <button class="btn c-blue" onclick="addManualQueue('kartu')">+ Kartu Induk</button>
                <button class="btn c-green" onclick="addManualQueue('gabung')">+ Label & Barcode</button>
                <button class="btn c-orange" onclick="addManualQueue('label')">+ Label Saja</button>
                <button class="btn c-grey" onclick="addManualQueue('barcode')">+ Barcode Saja</button>
            </div>
        </div>
    </details>
</div>

<h3 style="text-align:center; color:#555; margin-top:30px;">Preview Siap Cetak</h3>
<div id="preview-section"><div class="placeholder-text">Hasil generate akan muncul di sini...</div></div>

<div class="print-bar">
    <div style="padding-left:20px; font-weight:bold;">Total: <span id="count">0</span> Item</div>
    <div>
        <button class="btn c-grey" onclick="exportToCSV()">üì• Export SLiMS Compatible</button>
        <button class="btn c-red" onclick="resetPreview()">Reset</button>
        <button class="btn c-blue" style="font-size:16px; padding: 10px 25px;" onclick="window.print()">üñ®Ô∏è CETAK SEKARANG</button>
    </div>
</div>

<script>
    let stagingData = []; 
    let printQueue = [];
    let errorIndices = new Set(); // Menyimpan index baris yang error

    const fieldMapping = {
        "ukuran":"measure", "halaman":"pages", "jumlah halaman":"pages", "fisik":"pages",
        "jilid":"part", "edisi":"edition", "tahun":"year", "kota":"city", "penerbit":"publisher",
        "harga":"price", "sumber":"resource", "isbn":"isbn", "issn":"isbn"
    };

    const typeOptions = [
        {v:'a', t:'Textbook'}, {v:'b', t:'Reference'}, {v:'c', t:'Catalog'},
        {v:'d', t:'Journal'}, {v:'e', t:'Periodical'}, {v:'f', t:'Lainnya'}
    ];

    let activeColumns = [
        {id:'type', label:'Jenis', w:'12%'},
        {id:'title', label:'Judul', w:'20%'},
        {id:'author', label:'Penulis', w:'15%'},
        {id:'accNo', label:'No. Rek (ACC)', w:'10%'},
        {id:'barcode', label:'No. Barcode', w:'10%'},
        {id:'inventaris', label:'Inventaris', w:'10%'},
        {id:'classNo', label:'DDC', w:'8%'},
        {id:'callNo', label:'Call No', w:'10%'},
        {id:'resource', label:'Sumber', w:'10%'},
        {id:'date', label:'Tanggal', w:'10%'}
    ];

    window.onload = function() {
        ['conf_instansi_1','conf_instansi_2','conf_label','conf_barcode'].forEach(id => {
            if(localStorage.getItem(id)) document.getElementById(id).value = localStorage.getItem(id);
        });
        updateBulkDropdown();
        updateBulkInputType();
        renderStagingTable();
    }
    function saveConfig() {
        ['conf_instansi_1','conf_instansi_2','conf_label','conf_barcode'].forEach(id => {
            localStorage.setItem(id, document.getElementById(id).value);
        });
    }
    function toggleSettings() {
        const el = document.getElementById('settings-box');
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }
    function toggleCustomInput() {
        const ts = document.getElementById('type');
        const customInput = document.getElementById('customTypeInput');
        customInput.style.display = (ts.value === 'f') ? 'block' : 'none';
        if(ts.value === 'f') customInput.focus();
    }

    // --- BULK TOOL ---
    function updateBulkInputType() {
        const target = document.getElementById('bulk-target-field').value;
        const container = document.getElementById('bulk-input-container');
        let html = '';
        if(target === 'date') html = `<input type="date" id="bulk-value-input" style="width:120px;">`;
        else if (target === 'type') {
            let opts = typeOptions.map(o => `<option value="${o.v}">${o.t}</option>`).join('');
            html = `<select id="bulk-value-input" style="width:120px;">${opts}</select>`;
        } else html = `<input type="text" id="bulk-value-input" placeholder="Isi nilai baru..." style="width:120px;">`;
        container.innerHTML = html;
    }

    function addEmptyRows(count) {
        const selectedType = document.getElementById('importType').value;
        const today = new Date().toISOString().split('T')[0];
        for(let i=0; i<count; i++) {
            stagingData.push({
                id: Date.now() + Math.random(), type: selectedType,
                title: "", author: "", accNo: "", barcode: "", inventaris: "", classNo: "", callNo: "",
                resource: "Input Manual", date: today, publisher: "", city: "", year: "", edition: "",
                part: "-", measure: "-", pages: "-", price: "-"
            });
        }
        renderStagingTable();
    }

    function addCustomColumn() {
        const name = prompt("Nama Kolom Baru (Misal: Ukuran, Halaman):");
        if(name) {
            let lowerName = name.toLowerCase().trim();
            let id = fieldMapping[lowerName] || "custom_" + name.replace(/\s+/g, '_');
            if(activeColumns.find(c => c.id === id)) { alert("Kolom sudah ada!"); return; }
            activeColumns.push({ id: id, label: name, w: '10%' });
            renderStagingTable();
            updateBulkDropdown();
            document.getElementById('bulk-target-field').value = id;
            updateBulkInputType();
        }
    }
    function removeColumn(id) {
        if(confirm('Hapus kolom ini dan datanya?')) {
            activeColumns = activeColumns.filter(c => c.id !== id);
            stagingData.forEach(d => { delete d[id]; });
            renderStagingTable();
            updateBulkDropdown();
        }
    }
    
    // --- FITUR BARU: HAPUS ROW ---
    function removeRow(index) {
        if(confirm("Hapus baris ini?")) {
            stagingData.splice(index, 1);
            // Re-calc errors indices? Better to just clear errors and re-render
            errorIndices.clear(); 
            renderStagingTable();
        }
    }

    function updateBulkDropdown() {
        const sel = document.getElementById('bulk-target-field');
        sel.innerHTML = `<option value="type">Jenis Koleksi</option><option value="barcode">No. Barcode</option><option value="resource">Sumber</option><option value="date">Tanggal Input</option><option value="publisher">Penerbit</option>`;
        activeColumns.forEach(col => {
            if(['type','barcode','resource','date'].includes(col.id)) return;
            const opt = document.createElement('option');
            opt.value = col.id; opt.innerText = col.label; sel.appendChild(opt);
        });
    }
    function applyBulkAction() {
        const field = document.getElementById('bulk-target-field').value;
        const val = document.getElementById('bulk-value-input').value;
        if(!field) return;
        if(confirm(`Ubah '${field}' menjadi '${val}' untuk ${stagingData.length} data?`)) {
            stagingData.forEach(d => { d[field] = val; });
            // Jika bulk edit barcode, bersihkan error
            if(field === 'barcode' && val.trim() !== "") errorIndices.clear();
            renderStagingTable();
        }
    }

    function parseCSVRow(row) {
        const regex = /(?:^|,)(?:"([^"]*)"|([^",]*))/g;
        let columns = []; let match;
        while ((match = regex.exec(row))) { columns.push((match[1] || match[2] || "").trim()); }
        return columns;
    }
    function cleanSlimsData(str) { return str ? str.replace(/[<>]/g, '').trim() : ""; }

    function processCSV() {
        const fileInput = document.getElementById('csvFileInput');
        if (!fileInput.files[0]) { alert("Pilih file CSV dulu!"); return; }
        const selectedType = document.getElementById('importType').value;

        const reader = new FileReader();
        reader.onload = function(e) {
            const rows = e.target.result.split("\n");
            let count = 0;
            rows.forEach((row, idx) => {
                if(!row.trim()) return;
                const cols = parseCSVRow(row);
                if(idx === 0 && cols[0].toLowerCase().includes("title")) return;
                if(cols.length > 5) {
                    let auth = cleanSlimsData(cols[15]) || cleanSlimsData(cols[1]); 
                    let itemCode = cleanSlimsData(cols[cols.length-1]) || cols[8]; 
                    let data = {
                        id: Date.now() + Math.random(),
                        type: selectedType, 
                        title: cols[0] || "", edition: cols[2] || "", isbn: cols[3] || "", 
                        publisher: cols[4] || "", year: cols[5] || "", pages: cols[6] || "", 
                        callNo: cols[8] || "", city: cols[10] || "", classNo: cols[11] || "", 
                        author: auth, inventaris: itemCode, accNo: itemCode, barcode: itemCode, 
                        price: "-", resource: "Import SLiMS", date: new Date().toISOString().split('T')[0],
                        part: "-", measure: "-"
                    };
                    stagingData.push(data);
                    count++;
                }
            });
            renderStagingTable();
            alert(`Berhasil load ${count} data.`);
            fileInput.value = "";
        };
        reader.readAsText(fileInput.files[0]);
    }

    function renderStagingTable() {
        const thead = document.getElementById('staging-head');
        const tbody = document.getElementById('staging-body');
        
        let headerHTML = `<tr>
            <th width="40" style="text-align:center;"><input type="checkbox" onchange="toggleSelectAll(this)" checked></th>
            <th width="30"></th>`; // Header untuk tombol hapus
        activeColumns.forEach(col => { 
            headerHTML += `<th width="${col.w}">${col.label} <span class="del-col-btn" onclick="removeColumn('${col.id}')">√ó</span></th>`; 
        });
        headerHTML += `</tr>`;
        thead.innerHTML = headerHTML;

        let bodyHTML = "";
        stagingData.forEach((d, idx) => {
            // Cek apakah baris ini ada di daftar error
            const errorClass = errorIndices.has(idx) ? 'row-error' : '';

            bodyHTML += `<tr id="row-${idx}" class="${errorClass}">
                <td style="text-align:center;"><input type="checkbox" class="chk-item" value="${idx}" checked></td>
                <td style="text-align:center;"><button class="btn-del-row" onclick="removeRow(${idx})">üóëÔ∏è</button></td>`;
            
            activeColumns.forEach(col => {
                let val = d[col.id] || "";
                if(col.id === 'type') {
                    let opts = typeOptions.map(o => `<option value="${o.v}" ${val===o.v?'selected':''}>${o.t}</option>`).join('');
                    bodyHTML += `<td><select class="tbl-input" onchange="updateStaging(${idx}, 'type', this.value)">${opts}</select></td>`;
                } else {
                    let inputType = (col.id === 'date') ? 'date' : 'text';
                    bodyHTML += `<td><input type="${inputType}" class="tbl-input" value="${val}" onchange="updateStaging(${idx}, '${col.id}', this.value)"></td>`;
                }
            });
            bodyHTML += `</tr>`;
        });
        tbody.innerHTML = bodyHTML;
        document.getElementById('staging-controls').style.display = 'block';
        document.getElementById('staging-wrapper').style.display = 'block';
        document.getElementById('staging-count').innerText = stagingData.length;
    }

    function updateStaging(idx, field, val) { 
        stagingData[idx][field] = val; 
        
        // AUTO FIX: Jika field yang diubah adalah barcode dan tidak kosong, hilangkan merah
        if(field === 'barcode' && val.trim() !== "") {
            if(errorIndices.has(idx)) {
                errorIndices.delete(idx);
                // Langsung update class tanpa render ulang semua (agar fokus tidak hilang)
                document.getElementById(`row-${idx}`).classList.remove('row-error');
            }
        }
    }
    function toggleSelectAll(src) { document.querySelectorAll('.chk-item').forEach(cb => cb.checked = src.checked); }
    function clearStaging() { stagingData = []; errorIndices.clear(); renderStagingTable(); }

    // --- GENERATE WITH SMART VALIDATION ---
    function generateFromStaging() {
        const checkboxes = document.querySelectorAll('.chk-item:checked');
        if(checkboxes.length === 0) { alert("Pilih data dulu!"); return; }
        const mode = document.getElementById('bulk-mode').value;
        
        // 1. Kumpulkan semua error terlebih dahulu
        let currentErrors = [];
        let cleanData = [];

        checkboxes.forEach(cb => {
            const idx = parseInt(cb.value);
            const raw = stagingData[idx];
            
            // Cek kondisi error (Hanya jika mode butuh barcode)
            if((mode==='gabung' || mode==='barcode') && (!raw.barcode || raw.barcode.trim()==="")) {
                currentErrors.push(idx);
            } else {
                cleanData.push(raw);
            }
        });

        // 2. Jika ada error, tampilkan peringatan SEKALI SAJA dan tandai merah
        if(currentErrors.length > 0) {
            // Update global error indices
            currentErrors.forEach(i => errorIndices.add(i));
            renderStagingTable(); // Render ulang untuk menampilkan warna merah
            
            alert(`PERHATIAN:\nTerdapat ${currentErrors.length} data yang belum memiliki Barcode.\n\nData tersebut telah ditandai dengan warna MERAH di tabel.\nSilakan isi barcode atau pilih mode 'Label Saja'.`);
            
            // Jangan generate yang error, tapi boleh generate yang bersih?
            // Biasanya user ingin membetulkan dulu. Kita stop saja.
            return; 
        }

        // 3. Jika aman, proses generate
        cleanData.forEach(raw => {
            let extras = [];
            for (const key in raw) {
                if (key.startsWith('custom_')) {
                    const colDef = activeColumns.find(c => c.id === key);
                    const label = colDef ? colDef.label : key;
                    if(raw[key]) extras.push({ label: label, value: raw[key] });
                }
            }
            const d = {
                mode: mode, type: raw.type || 'a',
                title: raw.title, author: raw.author, classNo: raw.classNo, callNo: raw.callNo,
                inventaris: raw.inventaris, isbn: raw.isbn, publisher: raw.publisher, city: raw.city,
                year: raw.year, edition: raw.edition, part: raw.part || "-", measure: raw.measure || "-", 
                pages: raw.pages, price: raw.price, date: raw.date, resource: raw.resource, 
                accNo: raw.accNo, barcode: raw.barcode,
                customType: '', extras: extras
            };
            addToPreview(d);
        });
        document.getElementById('preview-section').scrollIntoView({behavior: "smooth"});
    }

    function addManualQueue(mode) {
        // ... (Kode sama seperti sebelumnya) ...
        const getVal = (id) => document.getElementById(id).value || "-";
        const typeSelect = document.getElementById('type');
        const customTypeVal = document.getElementById('customTypeInput').value;
        
        let extras = [];
        document.querySelectorAll('.dynamic-row').forEach(row => {
            const l = row.querySelector('.dyn-label').value;
            const v = row.querySelector('.dyn-val').value;
            if(l && v) extras.push({label: l, value: v});
        });

        const accInput = document.getElementById('accNo').value;
        const bcInput = document.getElementById('barcodeInput').value;

        if((mode==='gabung'||mode==='barcode') && !bcInput) { 
            alert("HARAP ISI NO. BARCODE TERLEBIH DAHULU!");
            return; 
        }

        const d = {
            mode: mode,
            type: typeSelect.value, customType: customTypeVal,
            title: getVal('title'), author: getVal('author'), classNo: getVal('classNo'), callNo: getVal('callNo'),
            inventaris: getVal('inventaris'), isbn: getVal('isbn'), publisher: getVal('publisher'), city: getVal('city'),
            year: getVal('year'), edition: getVal('edition'), part: getVal('part'), measure: getVal('measure'), pages: getVal('pages'),
            price: getVal('price'), date: getVal('date')==='-' ? new Date().toISOString().split('T')[0] : getVal('date'),
            resource: getVal('resource'), 
            accNo: accInput, 
            barcode: bcInput,
            extras: extras
        };
        addToPreview(d);
    }

    function addToPreview(d) {
        printQueue.push(d);
        const uid = "item-" + Date.now() + Math.random();
        const cfg = {
            h1: document.getElementById('conf_instansi_1').value, h2: document.getElementById('conf_instansi_2').value,
            lbl: document.getElementById('conf_label').value, bc: document.getElementById('conf_barcode').value
        };
        const sec = document.getElementById('preview-section');
        if(sec.querySelector('.placeholder-text')) sec.innerHTML = "";

        let content = "";
        if (d.mode === 'kartu') {
            let types = {a:"Textbook", b:"Reference", c:"Catalog", d:"Journal", e:"Periodical"};
            if (d.type === 'f') types['f'] = d.customType || "Lainnya"; else types['f'] = ".....";
            
            let typeStr = Object.keys(types).map(k => `<span style="white-space:nowrap; ${k===d.type?'font-weight:bold;text-decoration:underline;color:black':'color:#bbb'}">${k}. ${types[k]}</span>`).join(" ");
            let extraRows = d.extras.map(e => `<tr><td class="col-lbl">${e.label}</td><td class="col-sep">:</td><td class="col-val">${e.value}</td></tr>`).join("");

            content = `
            <div class="kartu-induk">
                <div style="font-size:9pt; width:100%;">${typeStr}</div>
                <div style="text-align:center;font-weight:bold;margin:8px 0;">${cfg.h1}<br>${cfg.h2}</div>
                <table class="tbl-data">
                    <tr><td class="col-lbl">Penulis<br><span class="eng">Author</span></td><td class="col-sep">:</td><td class="col-val">${d.author}</td></tr>
                    <tr><td class="col-lbl">Judul<br><span class="eng">Title</span></td><td class="col-sep">:</td><td class="col-val">${d.title}</td></tr>
                    <tr><td colspan="3"><div class="combo-row"><div class="combo-item"><span class="combo-label">Jilid:</span> ${d.part} <span class="combo-eng">Part</span></div><div class="combo-item"><span class="combo-label">Thn:</span> ${d.year} <span class="combo-eng">Year</span></div><div class="combo-item"><span class="combo-label">Ed:</span> ${d.edition} <span class="combo-eng">Edition</span></div></div></td></tr>
                    <tr><td class="col-lbl">Penerbit<br><span class="eng">Publisher</span></td><td class="col-sep">:</td><td class="col-val">${d.publisher}, ${d.city}</td></tr>
                    <tr><td colspan="3"><div class="combo-row"><div class="combo-item"><span class="combo-label">Hrg:</span> ${d.price} <span class="combo-eng">Price</span></div><div class="combo-item"><span class="combo-label">Tgl:</span> ${d.date} <span class="combo-eng">Date</span></div><div class="combo-item"><span class="combo-label">Smbr:</span> ${d.resource} <span class="combo-eng">Source</span></div></div></td></tr>
                    <tr><td colspan="3"><div class="combo-row"><div class="combo-item"><span class="combo-label">Ukuran:</span> ${d.measure} <span class="combo-eng">Measure</span></div><div class="combo-item"><span class="combo-label">Halaman:</span> ${d.pages} <span class="combo-eng">Pages</span></div></div></td></tr>
                    <tr><td class="col-lbl">No. Rek<br><span class="eng">ACC No</span></td><td class="col-sep">:</td><td class="col-val"><b>${d.accNo || "-"}</b></td></tr>
                    <tr><td class="col-lbl">ISBN</td><td class="col-sep">:</td><td class="col-val">${d.isbn}</td></tr>
                    <tr><td class="col-lbl">Inventaris</td><td class="col-sep">:</td><td class="col-val">${d.inventaris}</td></tr>
                    ${extraRows}
                </table>
            </div>`;
        } else {
            const color = getDDCColor(d.classNo);
            const lbl = `<div class="spine-label"><div class="color-strip" style="background:${color}!important;"></div><div class="lbl-content"><div style="font-size:10px;">${cfg.lbl}</div><br><div style="font-size:14pt;">${d.classNo}</div><div>${d.author.substring(0,3).toUpperCase()}</div><div>${d.title.substring(0,1).toLowerCase()}</div></div></div>`;
            
            let displayTitle = d.title;
            if (displayTitle.length > 15) { displayTitle = displayTitle.substring(0, 15) + "..."; }

            let bc = "";
            if (d.barcode && d.barcode.trim() !== "") {
                bc = `<div class="barcode-box">
                        <div style="font-size:7pt;">${cfg.bc}</div>
                        <svg id="bc-${uid}" style="width:90%; height:40px;"></svg>
                        <div class="barcode-title">${displayTitle}</div>
                      </div>`;
            } else {
                bc = `<div class="barcode-box" style="justify-content:center; color:red; font-size:10px; border:1px dotted red;">[BARCODE KOSONG]</div>`;
            }

            if(d.mode==='gabung') content = `<div class="sticker-unit">${lbl}${bc}</div>`;
            else if(d.mode==='label') content = lbl;
            else content = bc;
        }

        const wrap = document.createElement('div');
        wrap.className = 'print-item-wrapper';
        wrap.innerHTML = `<div class="delete-btn" onclick="this.parentElement.remove();updateCount()">X</div>` + content;
        sec.appendChild(wrap);

        if(d.mode!=='kartu' && d.mode!=='label' && d.barcode && d.barcode.trim() !== "") {
            setTimeout(() => { 
                const element = document.getElementById("bc-" + uid);
                if(element) {
                    try {
                        JsBarcode(element, d.barcode, { format: "CODE128", width: 2, height: 40, displayValue: true, fontSize: 12, margin: 0 });
                    } catch(err) { element.parentNode.innerHTML = "<span style='color:red;font-size:10px'>Error Kode</span>"; }
                }
            }, 200); 
        }
        updateCount();
    }

    function resetPreview() { document.getElementById('preview-section').innerHTML='<div class="placeholder-text">...</div>'; printQueue=[]; updateCount(); }
    function updateCount() { document.getElementById('count').innerText = document.querySelectorAll('.print-item-wrapper').length; }
    function getDDCColor(c) { return {'0':'#8B4513','1':'#800080','2':'#FFA500','3':'#006400','4':'#FFC0CB','5':'#000000','6':'#FF0000','7':'#8B0000','8':'#FFFF00','9':'#FFFFFF'}[c&&c[0]] || "#fff"; }
    function addDynamicFieldManual() { document.getElementById('dynamic-fields-area').insertAdjacentHTML('beforeend', `<div class="dynamic-row"><input class="dyn-label" placeholder="Label"><input class="dyn-val" placeholder="Isi"><button class="btn-sm-del" onclick="this.parentElement.remove()">X</button></div>`); }
    
    function exportToCSV() {
        const data = stagingData.length ? stagingData : printQueue;
        if(!data.length) return alert("Data kosong");
        let csvContent = '"Title","GMD","Edition","ISBN","Publisher","Year","Collation","Series Title","Call Number","Language","Place","Classification","Notes","Image","File","Author","Subject","Item Code"\n';
        data.forEach(d => {
             const row = [
                 `"${d.title||''}"`, `"Text"`, `"${d.edition||''}"`, `"${d.isbn||''}"`,
                 `"${d.publisher||''}"`, `"${d.year||''}"`, `"${d.pages||d.measure||''}"`, `""`,
                 `"${d.callNo||''}"`, `"Indonesia"`, `"${d.city||''}"`, `"${d.classNo||''}"`,
                 `""`, `""`, `""`, `"<${d.author||''}>"`, `""`, `"<${d.barcode||d.inventaris||''}>"`
             ].join(",");
             csvContent += row + "\n";
        });
        const link = document.createElement("a");
        link.href = "data:text/csv;charset=utf-8," + encodeURI(csvContent);
        link.download = "slims_compatible_export.csv";
        link.click();
    }
</script>
</body>
</html>
