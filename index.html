<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Biblio-Print</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <style>
        /* --- TAMPILAN UMUM (MONITOR) --- */
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f5; margin: 0; padding: 20px; padding-bottom: 120px; }
        .container { 
            max-width: 95%; margin: 0 auto 30px auto; 
            background: white; padding: 25px; border-radius: 8px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
        }
        
        h2 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; margin-top: 0; display: flex; justify-content: space-between; align-items: center; }
        .settings-link { font-size: 14px; color: #3498db; cursor: pointer; text-decoration: underline; }
        
        /* FORM INPUT */
        .form-row { display: flex; gap: 15px; margin-bottom: 12px; }
        .form-col { flex: 1; }
        label { display: block; font-weight: 600; font-size: 13px; margin-bottom: 5px; color: #34495e; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 13px; }

        /* PENGATURAN & IMPORT */
        #settings-box { display: none; background: #f8f9fa; border: 1px solid #ced4da; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .io-box { background: #e8f8f5; border: 1px solid #a2d9ce; padding: 15px; border-radius: 5px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }

        /* STAGING TABLE */
        .staging-wrapper { max-height: 300px; overflow-y: auto; border: 1px solid #ccc; margin-bottom: 15px; display: none; }
        .staging-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .staging-table th { background: #34495e; color: white; padding: 8px; position: sticky; top: 0; }
        .staging-table td { border-bottom: 1px solid #eee; padding: 5px; }
        .staging-controls { background: #fff3cd; padding: 10px; border: 1px solid #ffeeba; margin-bottom: 20px; display: none; align-items: center; justify-content: space-between; }

        /* DYNAMIC FIELDS */
        #dynamic-fields-area { margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 10px; }
        .dynamic-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: flex-end; }
        .btn-sm-del { background: #e74c3c; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; }

        /* BUTTONS */
        .action-area { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; text-align: center; }
        .btn { padding: 8px 15px; border: none; cursor: pointer; color: white; border-radius: 4px; font-weight: bold; margin: 2px; font-size: 13px; }
        .c-blue { background: #2980b9; } .c-green { background: #27ae60; }
        .c-orange { background: #f39c12; } .c-grey { background: #7f8c8d; } .c-red { background: #c0392b; }

        /* PREVIEW AREA */
        #preview-section {
            width: 100%; max-width: 21cm; margin: 0 auto; background: #fff; min-height: 200px;
            padding: 20px; border: 2px dashed #bbb; display: flex; flex-wrap: wrap;
            align-content: flex-start; gap: 10px; 
        }
        .placeholder-text { width: 100%; text-align: center; color: #aaa; padding-top: 50px; font-style: italic; }

        .print-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #2c3e50; color: white; padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2); z-index: 1000;
        }

        /* --- CSS PRINT --- */
        @media print {
            body { background: white; padding: 0; margin: 0; }
            .container, .print-bar, .delete-btn { display: none !important; }
            #preview-section { border: none; width: 100%; max-width: 100%; margin: 0; padding: 0; display: block; }
            .print-item-wrapper { float: left; margin: 5px; page-break-inside: avoid; }
            @page { margin: 0.5cm; size: auto; }
        }

        .print-item-wrapper { position: relative; display: inline-block; vertical-align: top; margin: 5px; }
        .delete-btn {
            position: absolute; top: -8px; right: -8px;
            background: red; color: white; border-radius: 50%;
            width: 20px; height: 20px; text-align: center; line-height: 20px;
            cursor: pointer; font-weight: bold; font-size: 12px;
            border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10;
        }

        /* --- LAYOUT KARTU INDUK (BARU) --- */
        .kartu-induk {
            width: 12cm; min-height: 9.5cm; height: auto; 
            border: 1px solid black; padding: 15px;
            font-family: "Times New Roman", serif; font-size: 11pt;
            background: white; box-sizing: border-box; 
            display: flex; flex-direction: column; justify-content: flex-start; 
        }
        
        /* Table Layout */
        .tbl-data { width: 100%; border-collapse: collapse; margin-top: 5px; }
        .tbl-data td { vertical-align: top; padding: 3px 0; } 
        
        .col-lbl { font-weight: bold; width: 22%; line-height: 1.2; } 
        .col-sep { width: 2%; text-align: center; } 
        .col-val { width: 76%; border-bottom: 1px dotted #ccc; }

        /* Styling Bahasa Inggris */
        .eng { 
            display: block; 
            font-size: 8pt; 
            font-style: italic; 
            color: #555; 
            font-weight: normal;
            margin-top: 2px;
        }

        /* Baris Gabungan (Flexbox) */
        .combo-row { display: flex; width: 100%; border-bottom: 1px dotted #ccc; padding-bottom: 2px; }
        .combo-item { flex: 1; margin-right: 5px; }
        .combo-label { font-weight: bold; font-size: 11pt; display: inline-block; }
        .combo-eng { font-size: 8pt; font-style: italic; color: #555; display: block; line-height: 1; }
        .combo-val { margin-left: 5px; }

        /* --- LABEL & BARCODE --- */
        .sticker-unit { display: inline-flex; border: 1px dashed #ccc; padding: 3px; background: white; align-items: center; gap: 3px; }
        .spine-label { width: 3cm; height: 4cm; border: 1px solid black; display: flex; flex-direction: column; text-align: center; }
        .color-strip { height: 12px; border-bottom: 1px solid #ccc; width: 100%; -webkit-print-color-adjust: exact; }
        .lbl-content { flex: 1; display: flex; flex-direction: column; justify-content: center; font-weight: bold; font-family: Arial; }
        
        .barcode-box { width: 4.5cm; height: 4cm; border: 1px solid black; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 2px; }
        .barcode-box svg { width: 100%; height: auto; max-height: 60px; display: block; } 
    </style>
</head>
<body>

<div class="container">
    <h2>
        Biblio-Print
        <span class="settings-link" onclick="toggleSettings()">‚öôÔ∏è Pengaturan Kopsurat</span>
    </h2>

    <div id="settings-box">
        <b style="color:#e67e22;">Edit Kop & Label (Otomatis Tersimpan)</b>
        <div class="form-row" style="margin-top:10px;">
            <div class="form-col"><label>Nama Instansi (Baris 1)</label><input type="text" id="conf_instansi_1" value="UPT PERPUSTAKAAN" oninput="saveConfig()"></div>
            <div class="form-col"><label>Nama Instansi (Baris 2)</label><input type="text" id="conf_instansi_2" value="POLITEKNIK NEGERI BANDUNG" oninput="saveConfig()"></div>
        </div>
        <div class="form-row">
            <div class="form-col"><label>Teks Label Punggung (Atas)</label><input type="text" id="conf_label" value="POLBAN" oninput="saveConfig()"></div>
            <div class="form-col"><label>Teks Barcode (Atas)</label><input type="text" id="conf_barcode" value="UPT Perpustakaan" oninput="saveConfig()"></div>
        </div>
    </div>

    <div class="io-box">
        <div style="flex:1;">
            <b>Import Data CSV (SLiMS):</b><br>
            <small style="color:#555;">Support file <code>senayan_biblio_export.csv</code>. Data akan masuk ke tabel "Data Mentah".</small>
        </div>
        <div>
            <input type="file" id="csvFileInput" accept=".csv" style="padding:5px; background:white; border:1px solid #ccc;">
            <button class="btn c-green" onclick="processCSV()">üìÇ Load CSV</button>
        </div>
    </div>

    <div id="staging-controls" class="staging-controls">
        <div><b>2. Data Mentah:</b> <span id="staging-count">0</span> item. Pilih untuk dicetak.</div>
        <div>
            <select id="bulk-mode" style="width:auto; display:inline-block; padding:8px;">
                <option value="gabung">Label + Barcode</option>
                <option value="kartu">Kartu Induk</option>
                <option value="label">Label Punggung Saja</option>
                <option value="barcode">Barcode Saja</option>
            </select>
            <button class="btn c-blue" onclick="generateFromStaging()">‚¨áÔ∏è Generate Pilihan</button>
            <button class="btn c-red" onclick="clearStaging()">Hapus</button>
        </div>
    </div>
    <div id="staging-wrapper" class="staging-wrapper">
        <table class="staging-table" id="staging-table">
            <thead>
                <tr>
                    <th width="30"><input type="checkbox" onchange="toggleSelectAll(this)"></th>
                    <th>Judul</th><th>Penulis</th><th>DDC</th><th>Call No</th><th>Inventaris</th>
                </tr>
            </thead>
            <tbody id="staging-body"></tbody>
        </table>
    </div>

    <hr style="border:0; border-top:2px solid #eee; margin:20px 0;">

    <details open>
        <summary style="cursor:pointer; font-weight:bold; color:#2c3e50; margin-bottom:10px; font-size:16px;">Input Manual (Satu per Satu)</summary>
        <div style="padding:15px; background:#f9f9f9; border-radius:5px; border:1px solid #eee;">
            
            <div class="form-row">
                <div class="form-col">
                    <label>Jenis Koleksi</label>
                    <select id="type" onchange="toggleCustomInput()">
                        <option value="a">a. Textbook</option>
                        <option value="b">b. Reference</option>
                        <option value="c">c. Catalog</option>
                        <option value="d">d. Journal</option>
                        <option value="e">e. Periodical</option>
                        <option value="f">f. Lainnya (Tulis Sendiri)</option>
                    </select>
                    <input type="text" id="customTypeInput" placeholder="Ketik jenis..." style="display:none; margin-top:5px; background:#fffbe6; border-color:#f1c40f;">
                </div>
                <div class="form-col"><label>DDC (Klasifikasi)</label><input type="text" id="classNo" placeholder="600"></div>
                <div class="form-col"><label>Call No (Label)</label><input type="text" id="callNo" placeholder="600 ABC t"></div>
            </div>

            <div class="form-row">
                <div class="form-col"><label>Penulis</label><input type="text" id="author"></div>
                <div class="form-col" style="flex:2;"><label>Judul</label><input type="text" id="title"></div>
            </div>

            <div class="form-row">
                <div class="form-col"><label>Jilid/Cet. ke</label><input type="text" id="part"></div>
                <div class="form-col"><label>Tahun</label><input type="text" id="year"></div>
                <div class="form-col"><label>Edisi</label><input type="text" id="edition"></div>
            </div>

            <div class="form-row">
                <div class="form-col"><label>Harga</label><input type="text" id="price"></div>
                <div class="form-col"><label>Tanggal Input</label><input type="date" id="date"></div>
                <div class="form-col"><label>Sumber</label><input type="text" id="resource"></div>
            </div>

            <div class="form-row">
                <div class="form-col"><label>Penerbit</label><input type="text" id="publisher"></div>
                <div class="form-col"><label>Kota Terbit</label><input type="text" id="city"></div>
            </div>

            <div class="form-row">
                <div class="form-col"><label>Ukuran</label><input type="text" id="measure"></div>
                <div class="form-col"><label>Jumlah Halaman</label><input type="text" id="pages"></div>
            </div>

            <div class="form-row" style="background:#eafaf1; padding:10px; border-radius:5px; border:1px solid #abebc6;">
                <div class="form-col">
                    <label style="color:#d35400;">No. Rek / Barcode (Wajib)</label>
                    <input type="text" id="accNo" placeholder="Untuk barcode & No. Rek">
                </div>
                <div class="form-col"><label>ISBN/ISSN</label><input type="text" id="isbn"></div>
                <div class="form-col"><label>No. Inventaris</label><input type="text" id="inventaris"></div>
            </div>
            
            <div id="dynamic-fields-area"></div>
            <button class="btn c-grey" style="width:100%; margin-top:5px; margin-bottom:15px;" onclick="addDynamicField()">+ Tambah Baris Custom</button>

            <div class="action-area">
                <button class="btn c-blue" onclick="addManualQueue('kartu')">+ Kartu Induk</button>
                <button class="btn c-green" onclick="addManualQueue('gabung')">+ Label & Barcode</button>
                <button class="btn c-orange" onclick="addManualQueue('label')">+ Label Saja</button>
                <button class="btn c-grey" onclick="addManualQueue('barcode')">+ Barcode Saja</button>
            </div>
        </div>
    </details>
</div>

<h3 style="text-align:center; color:#555; margin-top:30px;">Preview Siap Cetak</h3>
<div id="preview-section">
    <div class="placeholder-text">Hasil generate akan muncul di sini...</div>
</div>

<div class="print-bar">
    <div style="padding-left:20px; font-weight:bold;">Siap Cetak: <span id="count">0</span> Item</div>
    <div>
        <button class="btn c-grey" onclick="exportToCSV()">üì• Export SLiMS Compatible</button>
        <button class="btn c-red" onclick="resetPreview()">Reset Preview</button>
        <button class="btn c-blue" style="font-size:16px; padding: 10px 25px;" onclick="window.print()">üñ®Ô∏è CETAK SEKARANG</button>
    </div>
</div>

<script>
    let stagingData = []; 
    let printQueue = [];  

    // --- CONFIG & LOAD ---
    window.onload = function() {
        if(localStorage.getItem('conf_instansi_1')) document.getElementById('conf_instansi_1').value = localStorage.getItem('conf_instansi_1');
        if(localStorage.getItem('conf_instansi_2')) document.getElementById('conf_instansi_2').value = localStorage.getItem('conf_instansi_2');
        if(localStorage.getItem('conf_label')) document.getElementById('conf_label').value = localStorage.getItem('conf_label');
        if(localStorage.getItem('conf_barcode')) document.getElementById('conf_barcode').value = localStorage.getItem('conf_barcode');
    }
    function saveConfig() {
        localStorage.setItem('conf_instansi_1', document.getElementById('conf_instansi_1').value);
        localStorage.setItem('conf_instansi_2', document.getElementById('conf_instansi_2').value);
        localStorage.setItem('conf_label', document.getElementById('conf_label').value);
        localStorage.setItem('conf_barcode', document.getElementById('conf_barcode').value);
    }
    function toggleSettings() {
        const el = document.getElementById('settings-box');
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }

    // Toggle Input Manual Lainnya
    function toggleCustomInput() {
        const typeSelect = document.getElementById('type');
        const customInput = document.getElementById('customTypeInput');
        if(typeSelect.value === 'f') {
            customInput.style.display = 'block';
            customInput.focus();
        } else {
            customInput.style.display = 'none';
        }
    }

    // --- CSV PARSER ---
    function parseCSVRow(row) {
        const regex = /(?:^|,)(?:"([^"]*)"|([^",]*))/g;
        let columns = [];
        let match;
        while ((match = regex.exec(row))) {
            let val = match[1] || match[2] || ""; 
            columns.push(val.trim());
        }
        return columns;
    }

    function cleanSlimsData(str) {
        if(!str) return "";
        return str.replace(/[<>]/g, '').trim();
    }

    // --- LOGIC IMPORT ---
    function processCSV() {
        const fileInput = document.getElementById('csvFileInput');
        if (!fileInput.files[0]) { alert("Pilih file CSV dulu!"); return; }

        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const rows = text.split("\n");
            
            let count = 0;
            rows.forEach((row, idx) => {
                if(!row.trim()) return;
                const cols = parseCSVRow(row);
                if(idx === 0 && cols[0].toLowerCase().includes("title")) return;

                if(cols.length > 5) {
                    let auth = cleanSlimsData(cols[15]) || cleanSlimsData(cols[1]); 
                    let itemCode = cleanSlimsData(cols[cols.length-1]) || cols[8]; 

                    let data = {
                        id: Date.now() + Math.random(),
                        title: cols[0],
                        edition: cols[2],
                        isbn: cols[3], 
                        publisher: cols[4],
                        year: cols[5],
                        collation: cols[6], 
                        callNo: cols[8], 
                        city: cols[10],
                        classification: cols[11], 
                        author: auth,
                        inventaris: itemCode, 
                        price: "-", 
                        resource: "Pengadaan"
                    };
                    stagingData.push(data);
                    count++;
                }
            });

            renderStagingTable();
            alert(`Berhasil load ${count} data SLiMS.`);
            fileInput.value = "";
        };
        reader.readAsText(fileInput.files[0]);
    }

    function renderStagingTable() {
        const tbody = document.getElementById('staging-body');
        tbody.innerHTML = "";
        document.getElementById('staging-wrapper').style.display = 'block';
        document.getElementById('staging-controls').style.display = 'flex';
        document.getElementById('staging-count').innerText = stagingData.length;

        stagingData.forEach((d, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="text-align:center;"><input type="checkbox" class="chk-item" value="${idx}" checked></td>
                <td>${d.title}</td>
                <td>${d.author}</td>
                <td>${d.classification || '-'}</td>
                <td>${d.callNo || '-'}</td>
                <td>${d.inventaris || '-'}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function toggleSelectAll(source) {
        document.querySelectorAll('.chk-item').forEach(cb => cb.checked = source.checked);
    }
    function clearStaging() {
        stagingData = []; renderStagingTable();
        document.getElementById('staging-wrapper').style.display = 'none';
        document.getElementById('staging-controls').style.display = 'none';
    }

    // --- GENERATE PREVIEW ---
    function generateFromStaging() {
        const checkboxes = document.querySelectorAll('.chk-item:checked');
        if(checkboxes.length === 0) { alert("Pilih minimal satu data!"); return; }
        const mode = document.getElementById('bulk-mode').value;
        
        checkboxes.forEach(cb => {
            const raw = stagingData[parseInt(cb.value)];
            const d = {
                mode: mode,
                title: raw.title, author: raw.author, 
                classNo: raw.classification, callNo: raw.callNo,
                inventaris: raw.inventaris, isbn: raw.isbn,
                publisher: raw.publisher, city: raw.city, year: raw.year,
                edition: raw.edition, part: "-",
                measure: "-", pages: raw.collation, 
                price: raw.price, date: new Date().toISOString().split('T')[0],
                resource: raw.resource, accNo: raw.inventaris, 
                type: 'a', customType: '', extras: []
            };
            addToPreview(d);
        });
        document.getElementById('preview-section').scrollIntoView({behavior: "smooth"});
    }

    function addManualQueue(mode) {
        const getVal = (id) => document.getElementById(id).value || "-";
        
        // Ambil Custom Type jika ada
        const typeSelect = document.getElementById('type');
        const customTypeVal = document.getElementById('customTypeInput').value;
        
        // Ambil Dynamic Fields
        const dynRows = document.querySelectorAll('.dynamic-row');
        let extras = [];
        dynRows.forEach(row => {
            const l = row.querySelector('.dyn-label').value;
            const v = row.querySelector('.dyn-val').value;
            if(l && v) extras.push({label: l, value: v});
        });

        const bc = getVal('accNo');
        if((mode==='gabung'||mode==='barcode') && (!bc || bc==='-')) {
            alert("No. Barcode Wajib diisi!"); return;
        }

        const d = {
            mode: mode,
            type: typeSelect.value, customType: customTypeVal,
            title: getVal('title'), author: getVal('author'),
            classNo: getVal('classNo'), callNo: getVal('callNo'),
            inventaris: getVal('inventaris'), isbn: getVal('isbn'),
            publisher: getVal('publisher'), city: getVal('city'),
            year: getVal('year'), edition: getVal('edition'), part: getVal('part'),
            measure: getVal('measure'), pages: getVal('pages'),
            price: getVal('price'), date: getVal('date')==='-' ? new Date().toISOString().split('T')[0] : getVal('date'),
            resource: getVal('resource'), accNo: bc,
            extras: extras
        };
        addToPreview(d);
    }

    function addToPreview(d) {
        printQueue.push(d);
        const section = document.getElementById('preview-section');
        if(section.querySelector('.placeholder-text')) section.innerHTML = "";

        const uid = "item-" + Date.now() + Math.random().toString(36).substr(2, 5);
        const cfg = {
            h1: document.getElementById('conf_instansi_1').value,
            h2: document.getElementById('conf_instansi_2').value,
            lbl: document.getElementById('conf_label').value,
            bc: document.getElementById('conf_barcode').value
        };

        let htmlContent = "";

        if (d.mode === 'kartu') {
            let types = {a:"Textbook", b:"Reference", c:"Catalog", d:"Journal", e:"Periodical"};
            if (d.type === 'f') types['f'] = d.customType || "Lainnya";
            else types['f'] = ".....";

            let typeStr = Object.keys(types).map(k => 
                `<span style="white-space:nowrap; ${k===d.type?'font-weight:bold;text-decoration:underline;color:black':'color:#bbb'}">${k}. ${types[k]}</span>`
            ).join("&nbsp;&nbsp; ");

            let extraRowsHTML = "";
            d.extras.forEach(item => {
                extraRowsHTML += `<tr><td class="col-lbl">${item.label}<br></td><td class="col-sep">:</td><td class="col-val">${item.value}</td></tr>`;
            });

            htmlContent = `
            <div class="kartu-induk">
                <div style="font-size:9pt; width:100%;">${typeStr}</div>
                <div style="text-align:center;font-weight:bold;margin: 8px 0; text-transform:uppercase;">
                    ${cfg.h1}<br>${cfg.h2}
                </div>
                <table class="tbl-data">
                    <tr>
                        <td class="col-lbl">Penulis<br><span class="eng">Author</span></td>
                        <td class="col-sep">:</td>
                        <td class="col-val">${d.author}</td>
                    </tr>
                    <tr>
                        <td class="col-lbl">Judul<br><span class="eng">Title</span></td>
                        <td class="col-sep">:</td>
                        <td class="col-val">${d.title}</td>
                    </tr>
                    <tr>
                        <td colspan="3" style="padding:0;">
                            <div class="combo-row">
                                <div class="combo-item">
                                    <span class="combo-label">Jilid/Cet. ke:</span> ${d.part}
                                    <span class="combo-eng">Part</span>
                                </div>
                                <div class="combo-item">
                                    <span class="combo-label">Tahun:</span> ${d.year}
                                    <span class="combo-eng">Year</span>
                                </div>
                                <div class="combo-item">
                                    <span class="combo-label">Edisi ke:</span> ${d.edition}
                                    <span class="combo-eng">Edition</span>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-lbl">Penerbit<br><span class="eng">Publisher</span></td>
                        <td class="col-sep">:</td>
                        <td class="col-val">${d.publisher}, ${d.city}</td>
                    </tr>
                     <tr>
                        <td colspan="3" style="padding:0;">
                            <div class="combo-row">
                                <div class="combo-item">
                                    <span class="combo-label">Harga:</span> ${d.price}
                                    <span class="combo-eng">Price</span>
                                </div>
                                <div class="combo-item">
                                    <span class="combo-label">Tgl:</span> ${d.date}
                                    <span class="combo-eng">Date</span>
                                </div>
                                <div class="combo-item">
                                    <span class="combo-label">Sumber:</span> ${d.resource}
                                    <span class="combo-eng">Source</span>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="3" style="padding:0;">
                            <div class="combo-row">
                                <div class="combo-item">
                                    <span class="combo-label">Ukuran:</span> ${d.measure}
                                    <span class="combo-eng">Measure</span>
                                </div>
                                <div class="combo-item">
                                    <span class="combo-label">Jumlah Halaman:</span> ${d.pages}
                                    <span class="combo-eng">Pages</span>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-lbl">No. Rek<br><span class="eng">ACC No.</span></td>
                        <td class="col-sep">:</td>
                        <td class="col-val"><b>${d.accNo}</b></td>
                    </tr>
                    <tr>
                        <td class="col-lbl">ISBN</td>
                        <td class="col-sep">:</td>
                        <td class="col-val">${d.isbn}</td>
                    </tr>
                    <tr>
                        <td class="col-lbl">No. Inventaris</td>
                        <td class="col-sep">:</td>
                        <td class="col-val">${d.inventaris}</td>
                    </tr>
                    ${extraRowsHTML}
                </table>
            </div>`;
        }
        else {
            const color = getDDCColor(d.classNo);
            const titleShort = (d.title.length > 15) ? d.title.substring(0,15)+"..." : d.title;

            const elLabel = `
                <div class="spine-label">
                    <div class="color-strip" style="background:${color} !important;"></div>
                    <div class="lbl-content">
                        <div style="font-size:10px;">${cfg.lbl}</div><br>
                        <div style="font-size:14pt;">${d.classNo}</div>
                        <div style="text-transform:uppercase;">${d.author.substring(0,3)}</div>
                        <div style="text-transform:lowercase;">${d.title.substring(0,1)}</div>
                    </div>
                </div>`;

            const elBarcode = `
                <div class="barcode-box">
                    <div style="font-size:7pt;">${cfg.bc}</div>
                    <svg class="barcode-svg" id="bc-${uid}"></svg>
                    <div style="font-size:8pt;margin-top:2px;">${titleShort}</div>
                </div>`;

            if (d.mode === 'gabung') htmlContent = `<div class="sticker-unit">${elLabel}${elBarcode}</div>`;
            else if (d.mode === 'label') htmlContent = elLabel;
            else if (d.mode === 'barcode') htmlContent = elBarcode;
        }

        const wrapper = document.createElement('div');
        wrapper.className = 'print-item-wrapper';
        wrapper.id = uid;
        wrapper.innerHTML = `<div class="delete-btn" onclick="this.parentElement.remove(); updateCount();">X</div>` + htmlContent;

        section.appendChild(wrapper);

        if(d.mode !== 'kartu' && d.mode !== 'label' && d.accNo && d.accNo !== "-") {
            setTimeout(() => {
                try { 
                    JsBarcode("#bc-"+uid, d.accNo, {format: "CODE128", width: 2, height: 40, displayValue: true, fontSize: 12, margin: 0}); 
                } catch(e) {}
            }, 100);
        }
        updateCount();
    }

    function resetPreview() {
        document.getElementById('preview-section').innerHTML = '<div class="placeholder-text">Hasil generate akan muncul di sini...</div>';
        printQueue = []; updateCount();
    }
    function updateCount() { 
        document.getElementById('count').innerText = document.querySelectorAll('.print-item-wrapper').length; 
    }
    function getDDCColor(code) {
        if(!code) return "#fff";
        const c = code.toString().charAt(0);
        const map = {'0':'#8B4513','1':'#800080','2':'#FFA500','3':'#006400','4':'#FFC0CB','5':'#000000','6':'#FF0000','7':'#8B0000','8':'#FFFF00','9':'#FFFFFF'};
        return map[c] || "#fff";
    }
    function addDynamicField() {
        const c = document.getElementById('dynamic-fields-area');
        const div = document.createElement('div');
        div.className = 'dynamic-row';
        div.innerHTML = `<input type="text" class="dyn-label" placeholder="Label"><input type="text" class="dyn-val" placeholder="Isi"><button class="btn-sm-del" onclick="this.parentElement.remove()">X</button>`;
        c.appendChild(div);
    }
    function exportToCSV() {
        let dataToExport = stagingData.length > 0 ? stagingData : printQueue;
        if(dataToExport.length === 0) { alert("Tidak ada data untuk diexport."); return; }
        let csvContent = '"Title","GMD","Edition","ISBN","Publisher","Year","Collation","Series Title","Call Number","Language","Place","Classification","Notes","Image","...","Author","Subject","Item Code"\n';
        dataToExport.forEach(d => {
             const row = [
                 `"${d.title||''}"`, `"Text"`, `"${d.edition||''}"`, `"${d.isbn||''}"`,
                 `"${d.publisher||''}"`, `"${d.year||''}"`, `"${d.pages||d.collation||''}"`, `""`,
                 `"${d.callNo||''}"`, `""`, `"${d.city||''}"`, `"${d.classNo||d.classification||''}"`,
                 `""`, `""`, `""`, `"<${d.author||''}>"`, `""`, `"<${d.accNo||d.inventaris||''}>"`
             ].join(",");
             csvContent += row + "\n";
        });
        const link = document.createElement("a");
        link.href = "data:text/csv;charset=utf-8," + encodeURI(csvContent);
        link.download = "slims_compatible_export.csv";
        link.click();
    }
</script>
</body>
</html>


